(function(){
  angular.module('starter', ['ionic', 'starter.controllers', 'starter.services', 'angularMoment', 'ngCordova', 'firebase'])

    .run(function($ionicPlatform, $state, ConfigurationService, UserService, EntityService) {
      $ionicPlatform.on('pause', function() {
        Firebase.goOffline();

      });
      $ionicPlatform.on('resume', function() {
        Firebase.goOnline();

      });
      $ionicPlatform.ready(function() {
        if (window.cordova && window.cordova.plugins && window.cordova.plugins.Keyboard) {
          setTimeout(function() {
            navigator.splashscreen.hide();
          }, 50);
          cordova.plugins.Keyboard.hideKeyboardAccessoryBar(true);
          cordova.plugins.Keyboard.disableScroll(true);

        }
        if (window.StatusBar) {
          StatusBar.styleDefault();
        }
        var isNotificationClicked = false;
        if(window.cordova && typeof window.plugins.OneSignal != 'undefined'){
          var notificationOpenedCallback = function (jsonData) {

            var messageDetails = {
              conversationId: jsonData.additionalData.conversationId,
              userName: jsonData.additionalData.userName,
              subjectName: jsonData.additionalData.subjectName,
              fbPhotoUrl: jsonData.additionalData.fbPhotoUrl
            }
            isNotificationClicked = true;
            EntityService.setMessageDetails(messageDetails);
            $state.go("chat");


          };
          window.plugins.OneSignal.init("ee6f85c1-a2ff-4d1b-9fa6-29dd4cc306ef",
            { googleProjectNumber: "238478083352" },
            notificationOpenedCallback);
          window.plugins.OneSignal.enableNotificationsWhenActive(false);
        }

        var user = ConfigurationService.UserDetails();
        if (user) {
          UserService.CheckUser()
            .then(function (user) {
              if(user.isNeedLogin === false){

                var ref = new Firebase("https://chatoi.firebaseio.com");

                ref.authWithCustomToken(user.fireToken, function (error, authData) {

                  if (error) {
                    console.log("Login Failed!", error);
                  } else {
                    if(!isNotificationClicked)
                      $state.go("tab.subjects");
                  }
                });
              }
              else{
                $state.go("login");
              }
            }, function (err) {
              $state.go("login");
            });
        }else{
          $state.go("login");
        }

      });
    })

    .config(function($stateProvider, $urlRouterProvider) {

      $stateProvider
        .state('tab', {
          url: '/tab',
          abstract: true,
          templateUrl: 'templates/tabs/html/tabs.html'
        })
        .state('login', {
          url: "/login",
          templateUrl: "templates/login/html/login.html",
          controller: "loginCtrl"

        })
        .state('chat', {
          url: "/chat",
          templateUrl: "templates/chat/html/chat.html",
          controller: "chatCtrl"

        })
        .state('userProfile', {
          url: "/userProfile/:userId/:first_name",
          templateUrl: "templates/profile/html/userProfile.html",
          controller: "userProfileCtrl"
        })
        .state('blockedUsers', {
          url: "/blockedUsers",
          templateUrl: "templates/blockedUsers/html/blockedUsers.html",
          controller: "blockedUsersCtrl"
        })

        // Each tab has its own nav history stack:

        .state('tab.subjects', {
          url: '/subjects',
          views: {
            'tab-subjects': {
              templateUrl: 'templates/subjects/html/subjects.html',
              controller: 'subjectsCtrl'
            }
          }
        })
        .state('tab.addSubject-s1', {
          url: "/addSubject-s1",
          views: {
            'tab-addSubject': {
              templateUrl: "templates/subjects/html/addSubject-s1.html",
              controller: 'addSubjectCtrl'
            }
          }
        })
        .state('tab.addSubject-s2', {
          url: "/addSubject-s2/:categoryId",
          views: {
            'tab-addSubject': {
              templateUrl: "templates/subjects/html/addSubject-s2.html",
              controller: 'addSubjectCtrl'
            }
          }
        })
        .state('tab.messages', {
          url: '/messages',
          views: {
            'tab-messages': {
              templateUrl: 'templates/messages/html/messages.html',
              controller: 'messagesCtrl'
            }
          }
        })


        .state('tab.myProfile', {
          url: '/myProfile',
          views: {
            'tab-myProfile': {
              templateUrl: 'templates/profile/html/myProfile.html',
              controller: 'myProfileCtrl'
            }
          }
        });

      // if none of the above states are matched, use this as the fallback


    });
})();


var common = new function () {
  this.indexOfConv = function (arr,convId){
    for(var i=0;i<arr.length;i++)
    {
      if(arr[i].conversationId===convId)
      {
        return i;
      }
    }
    return -1;
  }
}

var appControllers = angular.module('starter.controllers', []);
var appServices = angular.module('starter.services', []);

appControllers.controller('NewMessagesCtrl', function ($scope, MessagesService) {

  $scope.checkUndreadMessage = function(){

    return MessagesService.checkUndreadMessage();
  }
});

appControllers.controller('tabsCtrl', function ($scope, MessagesService) {

  $scope.checkUndreadMessage = function(){
    return MessagesService.checkUndreadMessage();
  }
});
appControllers.controller('AppCtrl', function ($scope, $state, $ionicHistory) {

  $scope.goBack = function(){
    if($state.current.name.indexOf('chat') >= 0){
      $state.go('tab.messages');
    }else{
      $ionicHistory.goBack();
    }

  }
});

appServices.factory('backcallFactory', ['$state','$rootScope','$ionicPlatform','$ionicHistory','$timeout',function($state,$rootScope,$ionicPlatform,$ionicHistory,$timeout){
  var obj={}
  obj.backCall=function(){
    var backbutton=0;
    $ionicPlatform.registerBackButtonAction(function () {
      if ($state.current.name === 'tab.subjects' || $state.current.name === 'tab.addSubject-s1' || $state.current.name === 'tab.messages' || $state.current.name === 'tab.myProfile' || $state.current.name === 'login') {
        if(backbutton==0){
          backbutton++;
          window.plugins.toast.showShortBottom('press back button again to exit.');
          $timeout(function(){backbutton=0;},3000);
        }else{
          navigator.app.exitApp();
        }
      }
      else if($state.current.name.indexOf('chat') >= 0){
        $state.go('tab.messages');
      }
      else if ($ionicHistory.viewHistory().backView != null){
        $ionicHistory.goBack();
      }
      else if($rootScope.TabName){
        $state.go($rootScope.TabName);
        $ionicHistory.clearHistory();
        $ionicHistory.clearCache();
      }else{
        $state.go('tab.subjects');
      }
    }, 100);//registerBackButton
  }//backcallfun
  return obj;
}]);

appServices.factory('focus', function($timeout, $window) {
  return function(id) {
    // timeout makes sure that it is invoked after any other event has been triggered.
    // e.g. click events that need to run before the focus or
    // inputs elements that are in a disabled state but are enabled when those events
    // are triggered.
    $timeout(function() {
      var element = $window.document.getElementById(id);
      if(element)
        element.focus();
    });
  };
});

appServices.directive('eventFocus', function(focus) {
  return function(scope, elem, attr) {
    elem.on(attr.eventFocus, function() {
      focus(attr.eventFocusId);
    });

    // Removes bound events in the element itself
    // when the scope is destroyed
    scope.$on('$destroy', function() {
      elem.off(attr.eventFocus);
    });
  };
});

(function () {

appServices.factory('ChatService', function($q, $timeout,SubjectService, $rootScope, $ionicScrollDelegate, $firebaseObject, $firebaseArray, ConfigurationService, NotificationService,$http){
  var allmessages = [];
  var userDetails = ConfigurationService.UserDetails();
  var userName = userDetails.first_name + " " + userDetails.last_name;
  var conversaionId;
  var myConversaionId;
  var createrId;
  var subjectId;
  var createrId;
  var myUrl;
  var otherUrl;
  var conversationUserRef;
  var conversationOterUserRef;
  var hanleMyMessageRead;
  var hanleOtherMessageRead;
  var isUserBlocked = false;
  var privecy;
  var scrollBottom = function(){
    //$timeout(function(){
    //  $('.chats').parent().scrollTop( $('.chats').parent()[0].scrollHeight);
    //},0)
    $ionicScrollDelegate.scrollBottom(false);

  };

  return {
    getMessages: function() {
      return allmessages;
    },
    setMessages: function(conversaion){
      conversaionId = conversaion;
      createrId = conversaionId.split("-")[0];
      subjectId = conversaionId.split("-")[1];
      myConversaionId = userDetails._id + '-' + subjectId;
      otherUrl = "https://chatoi.firebaseio.com/chats/" + createrId + "/" + myConversaionId;
      myUrl = "https://chatoi.firebaseio.com/chats/" + userDetails._id  + "/" + conversaionId;
      conversationUserRef = new Firebase('https://chatoi.firebaseio.com/conversationOnline/' + userDetails._id);
      conversationOterUserRef = new Firebase('https://chatoi.firebaseio.com/conversationOnline/' + createrId);

      hanleOtherMessageRead = new Firebase(otherUrl + "/read");
      hanleMyMessageRead = new Firebase(myUrl + "/read");
      hanleMyMessageRead.set(true);
      conversationUserRef.set({
        conversationId: conversaion,

      });
      var blockedUrl = "https://chatoi.firebaseio.com/chats/" + createrId + "/blocked/" + userDetails._id;
      var blockedRef = new Firebase(blockedUrl);

      blockedRef.on("value", function (userSnapshot) {
        if (userSnapshot.val()) {
          isUserBlocked = true;
        }else{
          isUserBlocked = false;
        }
      });


      var isUserOnlineRef = new Firebase('https://chatoi.firebaseio.com/presence/' + createrId);
      isUserOnlineRef.on("value", function (userSnapshot) {
        if (userSnapshot.val() && userSnapshot.val() == 'online') {
          $rootScope.$broadcast('sendUserOnlineEvent', true);
        }
        else{
          $rootScope.$broadcast('sendUserOnlineEvent', false);
        }
      });

      var firebaseRef = new Firebase('https://chatoi.firebaseio.com/chats/' + userDetails._id + '/' + conversaionId);
      var firebaseRef2 = new Firebase('https://chatoi.firebaseio.com/chats/' + userDetails._id + '/' + conversaionId +"/messages");
      var a = $firebaseArray(firebaseRef2);
      a.$loaded(function(h){
        allmessages = h;

        $rootScope.$broadcast('sendChatEvent', 'sendChatEvent');
      })

      firebaseRef.on('value', function(dataSnapshot) {
        privecy = false;
        var messages = [];
        messages =  dataSnapshot.val().messages;

        var counter = 0;
        var myMessages = 0;
        angular.forEach(messages, function(value, key) {
          if(counter == 3 && counter == myMessages){
            privecy = true;
          }
          if(counter == 4 && messages[key].sender != userDetails._id){
            privecy = false;
          }
          if(messages[key].sender == userDetails._id){
            myMessages ++;
          }
          counter++;

        });



        //$rootScope.$broadcast('sendChatEvent', 'sendChatEvent');

        scrollBottom();

      });
    },
    blockUser:function (chatDetails) {
      createrId = conversaionId.split("-")[0];
      var blockedUserRef=new Firebase("https://chatoi.firebaseio.com/chats/" + userDetails._id+"/blocked/"+createrId);
      var blockedUser = blockedUserRef.set({
        userName: chatDetails.userName,
        fbPhotoUrl: chatDetails.fbPhotoUrl,
        userId:createrId
      });
    },
    sendMessage: function(msg, chatDetails){
      if(privecy){
        ConfigurationService.showAlert();
        return;
      }


      var myRef, otherRef;
      var isFirstMessage = false;
      myConversaionId = userDetails._id + '-' + subjectId;

      if(!allmessages || allmessages.length == 0){
        isFirstMessage = true;
      }
      if(isFirstMessage){
        SubjectService.Interested(subjectId).then(function (result) {
        }, function (err) {
        });
        otherRef = new Firebase(otherUrl);
        myRef = new Firebase(myUrl);
        var otherToSend = {
          userName: userName,
          subjectName: chatDetails.subjectName,
          fbPhotoUrl: userDetails.fbPhotoUrl
        }

        myRef.set({
          userName: chatDetails.userName,
          subjectName: chatDetails.subjectName,
          fbPhotoUrl: chatDetails.fbPhotoUrl,
          read: true
        });

        if(isUserBlocked){
          otherToSend.read = true;
        }

        otherRef.set(otherToSend);
        isFirstMessage = false;
      }
      otherRef = new Firebase(otherUrl + "/messages");
      myRef = new Firebase(myUrl + "/messages");
      var newMessageOtherUrl = otherRef.push();
      var newMessageRef2 = myRef.push();
      var date = new Date();
      var msgTosend = {
        body: msg,
        sender: userDetails._id,
        create_date: date.toJSON(),
        date_string: date.toLocaleDateString()
      }

      newMessageRef2.set(msgTosend);
      if(!isUserBlocked){
        newMessageOtherUrl.set(msgTosend);

        var didUserRead = $firebaseObject(conversationOterUserRef);
        didUserRead.$loaded(function(value){
          if(!value){
            hanleOtherMessageRead.set(false);
          }else if (value.conversationId !== myConversaionId){
            hanleOtherMessageRead.set(false);
          }
          else{
            hanleOtherMessageRead.set(true);
          }
        })
        var userRef = new Firebase('https://chatoi.firebaseio.com/presence/' + createrId);
        var isOtherUserOnline = $firebaseObject(userRef);
        isOtherUserOnline.$loaded(function(value){
          if(value && value.$value == 'offline'){
            var message = {
              user: createrId,
              message: msg,
              conversationId: myConversaionId,
              userName: userName,
              subjectName: chatDetails.subjectName,
              fbPhotoUrl: userDetails.fbPhotoUrl
            }
            NotificationService.SendMessage(message)
              .then(function (message) {

              }, function (err) {
              });
          }
        })
      }
    },
    ReportUser: function (report) {
      var deferred = $q.defer();
      $http.post(ConfigurationService.ServerUrl() + '/api/users/report',report, {
        headers: {
          "access-token": ConfigurationService.UserDetails().token
        }
      }).success(function (data) {
        deferred.resolve(data);
      }).error(function (msg, code) {
        deferred.reject(msg);
        //   $log.error(msg, code);
      });
      return deferred.promise;
    },
    scrollBottom: scrollBottom
  }
})
})();

(function () {
  appServices.factory('ConfigurationService', function ($ionicPopup) {
    return {
      ServerUrl: function () {
         return "https://chatad.herokuapp.com";
        //return "http://localhost:3000";
        // return "http://192.168.1.14:3000";
      },

      CategoriesUrl: function (){
        //return "http://localhost:3000/categories/";
        return "https://chatad.herokuapp.com/categories/";
      },
      UserDetails: function () {
        if (!this.userDetails) {
          if (window.localStorage['user']) {
            this.userDetails = angular.fromJson(window.localStorage['user']);
          }
        }
        return this.userDetails;
      },
      Notification_token: function () {
        if (!this.notification_token) {
          if (window.localStorage['notification_token']) {
            this.notification_token = window.localStorage['notification_token']
          }
        }
        return this.notification_token;
      },
      MyFilter: function () {
        if (!this.myFilter) {
          if (window.localStorage['myFilter']) {
            this.myFilter = angular.fromJson(window.localStorage['myFilter'])
          }
        }
        var temp= {};
        angular.copy(this.myFilter,temp);
        return temp ;
      },
      SetMyFilter: function (myFilter) {
        if (myFilter) {
          window.localStorage['myFilter'] = angular.toJson(myFilter);
          this.myFilter = myFilter;
        }
      },
      SetNotification_token: function (notification_token) {
        if (notification_token) {
          window.localStorage['notification_token'] = angular.toJson(notification_token);
          this.notification_token = notification_token;
        }
      },
      showAlert: function() {
        var alertPopup = $ionicPopup.alert({
          title: 'info',
          template: 'wiat for the other user to answer you'
        });
        alertPopup.then(function(res) {
          console.log('Thank you for not eating my delicious ice cream cone');
        });
      },
      LogOut:function () {
        delete this.notification_token;
        delete this.myFilter;
        delete this.userDetails;
      }
    }
  });
})();

(function () {
  appServices.factory('EntityService', function (ConfigurationService, $q) {
    var otherProfile = null;
    var messageToDeal = null;
    var deleteFromArray = function (array, item) {
      for (var i = 0; i < array.length; i++) {
        if (array[i]._id == item._id) {
          array.splice(i, 1);
        }
      }
    };
    var setProfile = function (user) {
      otherProfile = user;
    }

    var getOtherProfile = function () {
      return otherProfile;
    }

    var setMessageDetails = function (message) {
      messageToDeal = message;
    }

    var getMessageDetails = function () {
      return messageToDeal;
    }

    return {
      deleteFromArray: deleteFromArray,
      setProfile: setProfile,
      getOtherProfile: getOtherProfile,
      setMessageDetails: setMessageDetails,
      getMessageDetails: getMessageDetails
    };
  });
})();

// (function () {
//   appServices.factory('Socket', function (socketFactory) {
//     var myIoSocket = io.connect('http://chat.socket.io:80');
//     mySocket = socketFactory({
//       ioSocket: myIoSocket
//     });
//     return mySocket;
//   })
// })()

(function () {
  appServices.factory('MessagesService', function ($rootScope, $ionicScrollDelegate, $firebaseObject, ConfigurationService) {
    var messages = [];
    var userDetails = ConfigurationService.UserDetails();

    var fillMessages = function () {
      var ref = new Firebase("https://chatoi.firebaseio.com/chats/" + userDetails._id);
      ref.on("value", function (snapshot) {
        messages = [];
        angular.forEach(snapshot.val(), function (value, key) {

          var conversationId = key;
          if (value.messages) {
            var messagesArray = Object.getOwnPropertyNames(value.messages);
            var lastMessageKey = messagesArray[messagesArray.length - 1];
            var lastMessage = value.messages[lastMessageKey].body;
            var createrId = conversationId.split("-")[0];

            var readMessage = false;
            if (value.read) {
              readMessage = value.read;
            }


            var indexx = common.indexOfConv(messages, conversationId);
            var msg = {
              conversationId: conversationId,
              lastMessage: lastMessage,
              lastMessageKey: lastMessageKey,
              subjectName: value.subjectName,
              fbPhotoUrl: value.fbPhotoUrl,
              userName: value.userName,
              readMessage: readMessage

            }

            if (indexx === -1) {
              messages.push(msg);
            }
            else {
              messages[indexx] = msg;

            }
            var userRef = new Firebase('https://chatoi.firebaseio.com/presence/' + createrId);
            userRef.on("value", function (userSnapshot) {
              var online = true;
              if (userSnapshot.val() == 'offline') {
                online = false;

              }
              var blockedUrl = "https://chatoi.firebaseio.com/chats/" + createrId + "/blocked/" + userDetails._id;
              var blockedRef = new Firebase(blockedUrl);
              var blockUser = $firebaseObject(blockedRef);
              blockUser.$loaded(function (value) {
                if (value.userId) {
                  online = false;
                }
                var indexx = common.indexOfConv(messages, conversationId);

                messages[indexx].online = online
                $rootScope.$broadcast('sendMessagesEvent', 'sendMessagesEvent');
              })


            });
          }

        });
      });
    }
    fillMessages();
    return {
      getMessages: function () {
        return messages;
      },
      setMessages: function () {
        fillMessages();
      },
      checkUndreadMessage: function () {
        for (var i = 0; i < messages.length; i++) {
          if (messages[i].readMessage === false) {
            return true;
          }
        }
        return false;
      }
    }
  })
})();

(function () {
appServices.factory('NotificationService', function ($http, $log, $q, ConfigurationService) {
  return {

    SendMessage: function (message) {
      var deferred = $q.defer();
      $http.post(ConfigurationService.ServerUrl() + '/api/notification',
        message
        , {
          headers: {
            "access-token": ConfigurationService.UserDetails().token
          }
        }).success(function (data) {
          deferred.resolve(data);
        }).error(function (msg, code) {
          deferred.reject(msg);
          //   $log.error(msg, code);
        });
      return deferred.promise;
    }
  }
})
})();

(function(){
  appServices.factory('SubjectService', function ($http, $log, $q, ConfigurationService, $cordovaGeolocation) {
    return {
      TimeToUpdateFromServer:1000*60*15,
      GetCategories: function () {
        var deferred = $q.defer();
        if((!ConfigurationService.categories)||(ConfigurationService.categories.datetime&&((new Date()).getTime()-ConfigurationService.categories.datetime.getTime())>this.TimeToUpdateFromServer)) {
          $http.get(ConfigurationService.ServerUrl() + '/api/subjects/categories', {
            headers: {
              "access-token": ConfigurationService.UserDetails().token
            }
          }).success(function (data) {
            ConfigurationService.categories = {
              data: data,
              datetime: new Date()
            }
            deferred.resolve(data);
          }).error(function (msg, code) {
            deferred.reject(msg);
            //   $log.error(msg, code);
          });
        }
        else
        {
          deferred.resolve(ConfigurationService.categories.data);

        }
        return deferred.promise;
      },
      GetSubjects: function (userSubjects,scrollOptions, userId) {
        var deferred = $q.defer();
        if (userId == undefined) {
          userId = null;
        }
        var myFilter = ConfigurationService.MyFilter();
        myFilter.limit = scrollOptions.limit;
        myFilter.skip = scrollOptions.skip;
        if (!myFilter.gender) {
          myFilter = {
            nearMe: false,
            gender: 'both',
            categories: []
          }
          ConfigurationService.SetMyFilter(myFilter);
        }
        if (myFilter.nearMe) {
          var posOptions = {timeout: 10000, enableHighAccuracy: false};
          $cordovaGeolocation
            .getCurrentPosition(posOptions)
            .then(function (position) {
              var lat = position.coords.latitude;
              var long = position.coords.longitude;
              myFilter.locationCoords = [lat, long];
              tryPost();
            }, function (err) {
              myFilter.locationCoords = [];
              tryPost();
              // error
            });
        }
        else {
          myFilter.locationCoords = [];
          tryPost();
        }
        // myFilter.categories = Object.keys(myFilter.categories);
        function tryPost() {
          $http.post(ConfigurationService.ServerUrl() + '/api/subjects/filter?userSubjects=' + userSubjects + '&userId=' + userId, myFilter, {
            headers: {
              "access-token": ConfigurationService.UserDetails().token
            }
          }).success(function (data) {
            deferred.resolve(data);
          }).error(function (msg, code) {
            deferred.reject(msg);
            //   $log.error(msg, code);
          });
        }

        return deferred.promise;
      },
      GetMySubjects: function (userId, status) {
        var deferred = $q.defer();
        if (userId == undefined) {
          userId = null;
        }
        tryPost();
        function tryPost() {
          $http.post(ConfigurationService.ServerUrl() + '/api/subjects/filter?userSubjects=true&status='+status + '&userId=' + userId, {}, {
            headers: {
              "access-token": ConfigurationService.UserDetails().token
            }
          }).success(function (data) {
            deferred.resolve(data);
          }).error(function (msg, code) {
            deferred.reject(msg);
            //   $log.error(msg, code);
          });
        }

        return deferred.promise;
      },
      Interested: function (subjectId) {
        var deferred = $q.defer();
        $http.post(ConfigurationService.ServerUrl() + '/api/subjects/interested', {subjectId:subjectId}, {
          headers: {
            "access-token": ConfigurationService.UserDetails().token
          }
        }).success(function (data) {
          deferred.resolve(data);
        }).error(function (msg, code) {
          deferred.reject(msg);
          //   $log.error(msg, code);
        });


        return deferred.promise;
      },
      ChangeStatus: function (subject,status) {
        var deferred = $q.defer();
        $http.post(ConfigurationService.ServerUrl() + '/api/subjects/status', {
          _id: subject._id,
          status: status
        }, {
          headers: {
            "access-token": ConfigurationService.UserDetails().token
          }
        }).success(function (data) {
          deferred.resolve(data);
        }).error(function (msg, code) {
          deferred.reject(msg);
          //   $log.error(msg, code);
        });


        return deferred.promise;
      },
      CreateSubject: function (subject) {
        var deferred = $q.defer();
        var posOptions = {timeout: 10000, enableHighAccuracy: false};
        $cordovaGeolocation
          .getCurrentPosition(posOptions)
          .then(function (position) {
            var lat = position.coords.latitude;
            var long = position.coords.longitude;
            subject.locationCoords = [lat, long];
            tryPost();
          }, function (err) {
            subject.locationCoords = [];
            tryPost();
            // error
          });
        function tryPost() {

          $http.post(ConfigurationService.ServerUrl() + '/api/subjects',
            subject
            , {
              headers: {
                "access-token": ConfigurationService.UserDetails().token
              }
            }).success(function (data) {
            deferred.resolve(data);
          }).error(function (msg, code) {
            deferred.reject(msg);
            //   $log.error(msg, code);
          });
        }

        return deferred.promise;
      },
      DeleteSubjects: function (subject) {
        var deferred = $q.defer();
        $http.delete(ConfigurationService.ServerUrl() + '/api/subjects?_id=' + subject._id, {
          headers: {
            "access-token": ConfigurationService.UserDetails().token
          }
        }).success(function (data) {
          deferred.resolve(data);
        }).error(function (msg, code) {
          deferred.reject(msg);
          //   $log.error(msg, code);
        });
        return deferred.promise;
      }
    }
  })
})();


(function () {
  appServices.factory('UserService', function ($http, $log, $q, $cordovaFacebook, ConfigurationService) {
    var userProfile = {};
    return {

      CreateUser: function (user) {
        var deferred = $q.defer();

        $http.post(ConfigurationService.ServerUrl() + '/api/users',
          user
          , {
            headers: {
              "Content-Type": "application/json"
            }
          }).success(function (data) {
          deferred.resolve(data);
        }).error(function (msg, code) {
          deferred.reject(msg);
          //   $log.error(msg, code);
        });
        return deferred.promise;
      },
      LogOut: function () {
        var deferred = $q.defer();

        $http.get(ConfigurationService.ServerUrl() + '/api/users/logOut', {
          headers: {
            "Content-Type": "application/json",
            "access-token": ConfigurationService.UserDetails().token
          }
        }).success(function (data) {
          deferred.resolve(data);
        }).error(function (msg, code) {
          deferred.reject(msg);
          //   $log.error(msg, code);
        });
        return deferred.promise;
      },
      GetUser: function (userId) {
        var deferred = $q.defer();
        $http.get(ConfigurationService.ServerUrl() + '/api/users/' + userId, {
          headers: {
            "access-token": ConfigurationService.UserDetails().token
          }
        }).success(function (data) {
          deferred.resolve(data);
        }).error(function (msg, code) {
          deferred.reject(msg);
          //   $log.error(msg, code);
        });
        return deferred.promise;
      },
      CheckUser: function (userId) {
        var deferred = $q.defer();
        $http.get(ConfigurationService.ServerUrl() + '/api/users', {
          headers: {
            "access-token": ConfigurationService.UserDetails().token
          }
        }).success(function (data) {
          deferred.resolve(data);
        }).error(function (msg, code) {
          deferred.reject(msg);
          //   $log.error(msg, code);
        });
        return deferred.promise;
      },
      FBlogin: function () {
        var deferred = $q.defer();
        $cordovaFacebook.login(["public_profile", "email", "user_friends", "user_birthday"]).then(
          function success(result) {
            deferred.resolve(result);
          },
          function error(reason) {
            alert(JSON.stringify(reason))
            deferred.reject(reason);
          }
        );
        return deferred.promise;
      },
      RegisterNotification: function (token) {
        var deferred = $q.defer();
        $http.post(ConfigurationService.ServerUrl() + '/api/users/notification',
          {
            "notification_token": token
          },
          {
            headers: {
              "access-token": ConfigurationService.UserDetails().token
            }
          }
        ).success(function (data) {
          deferred.resolve(data);
        }).error(function (msg, code) {
          deferred.reject(msg);
          //   $log.error(msg, code);
        });
        return deferred.promise;
      },
      SetUserProfile: function (message) {
        var createrId = message.conversationId.split("-")[0];
        userProfile.userId = createrId;
        userProfile.first_name = message.userName;

        userProfile.fbPhotoUrl = message.fbPhotoUrl;
      },
      GetUserProfile: function () {
        return userProfile;
      }
    }
  });
})();

(function () {
  appControllers.controller('blockedUsersCtrl', function ($scope, $rootScope,$state,$ionicPopup, $stateParams, $filter,$firebaseArray, $mdBottomSheet, $mdDialog, $mdToast, $ionicHistory,SubjectService,ConfigurationService,Firebase) {
    $scope.isExpanded = true;
    $rootScope.isHeaderExpanded = true;
    $scope.showConfirm = function(blockedUser) {
      var confirmPopup = $ionicPopup.confirm({
        title: 'Unblock User',
        template: 'Are you sure you want to remove'+ blockedUser.userName+' from your blocked users?'
      });
      confirmPopup.then(function(res) {
        if(res) {
          var blockedUserRef=new Firebase("https://chatoi.firebaseio.com/chats/" + $scope.userDetails._id+"/blocked/"+blockedUser.userId);
          blockedUserRef.remove();
          console.log('You are sure');
        } else {
          console.log('You are not sure');
        }
      });
    };
    $scope.userDetails = ConfigurationService.UserDetails();
    // initialForm is the first activity in the controller.
    // It will initial all variable data and let the function works when page load.
    $scope.initialForm = function () {
      var blockedUsersRef=new Firebase("https://chatoi.firebaseio.com/chats/" + $scope.userDetails._id+"/blocked/");
      $scope.blockedUsers=$firebaseArray(blockedUsersRef);
    };// End initialForm.
    $scope.initialForm();
  });
})();// End of Notes Detail Page  Controller.



(function () {
  appControllers.controller('chatCtrl', function ($scope, $ionicPopover, $timeout,$ionicScrollDelegate, $rootScope, $state,$ionicPopup, ConfigurationService, ChatService, UserService, EntityService,focus) {
  var date = new Date();
  $scope.dateString = date.toLocaleDateString();
  $scope.isExpanded = true;
  $rootScope.isHeaderExpanded = true;
  $scope.chatDetails = EntityService.getMessageDetails();
  $scope.conversationId = $scope.chatDetails.conversationId;
  $scope.messages = [];
  var createrId =  $scope.conversationId.split("-")[0];


  $scope.userDetails = ConfigurationService.UserDetails();
  ChatService.setMessages($scope.conversationId);
  $scope.messages = ChatService.getMessages();

  $timeout(function(){
    ChatService.scrollBottom();
  },100)

  window.addEventListener('native.keyboardshow', function(){
    $timeout(function(){
      $ionicScrollDelegate.scrollBottom(false);
    },300)

  });

  $rootScope.$on('sendChatEvent', function(event, mass) {
    $scope.messages = ChatService.getMessages();
    date = new Date();
    $scope.dateString = date.toLocaleDateString();
    if(!$scope.$$phase) {
      $scope.$apply();
    }
  });

    var myblockedUrl = "https://chatoi.firebaseio.com/chats/" + $scope.userDetails._id  + "/blocked/" + createrId;
    var myblockedRef = new Firebase(myblockedUrl);
    myblockedRef.on("value", function (userSnapshot) {
      if (userSnapshot.val()) {
        $scope.disableSend = true;
        $scope.sendInputPlaceHolder = "this user is blocked";
      }
      else{
        $scope.disableSend = false;
        $scope.sendInputPlaceHolder = "Message";
      }
    });
  // $rootScope.$on('otherUserBlock', function(event, mass) {
  //   $timeout(function(){
  //     if(mass){
  //       $scope.sendInputPlaceHolder = "this user is blocked"
  //     }
  //     $scope.disableSend = mass;
  //     $scope.$apply(function(){
  //       console.log("ss")
  //     });
  //   },3000)
  //
  //
  // });
  $scope.blockUser = function () {
    var confirmPopup = $ionicPopup.confirm({
      title: 'Block User',
      template: 'Are you sure you want to block '+ $scope.chatDetails.userName+' ?',
      buttons: [
        { text: 'Cancel' },
        {
          text: '<b>Block</b>',
          type: 'button-positive',
          onTap: function(e) {
            return "sss";
          }
        }
      ]
    });
    confirmPopup.then(function(res) {
      if(res) {
        ChatService.blockUser($scope.chatDetails);
        console.log('You are sure');
      } else {
        console.log('You are not sure');
      }
    });

  }

  $scope.reportUser=function () {
    $scope.data={is_toBlocked:true,reason:""};
    var confirmPopup = $ionicPopup.show({
      title: 'Report User',
      template: '<textarea cols="4" ng-model="data.reason" placeholder="Giv us more details"></textarea>   <md-checkbox aria-label="Checkbox" ng-model="data.is_toBlocked">Also block this user ? </md-checkbox>',
      scope: $scope,
      buttons: [
        { text: 'Cancel' },
        {
          text: '<b>Report</b>',
          type: 'button-positive',
          onTap: function(e) {
            return {is_toBlocked:$scope.data.is_toBlocked,report:{user:$scope.chatDetails.conversationId.split('-')[1],reason:$scope.data.reason}};
          }
        }
      ]
    });
    confirmPopup.then(function(res) {
      if(res) {
        ChatService.ReportUser(res.report);
        if(res.is_toBlocked)
        {
          ChatService.blockUser($scope.chatDetails);
        }
        console.log('You are sure');
      } else {
        console.log('You are not sure');
      }
    });

    //ChatService.blockUser($scope.chatDetails);
  }
  $scope.$on('$stateChangeStart',
    function(event, toState, toParams, fromState, fromParams, options){
      conversationUserRef = new Firebase('https://chatoi.firebaseio.com/conversationOnline/' + $scope.userDetails._id);
      conversationUserRef.remove();
    })

  $scope.messageIsMine = function(userId){
    return $scope.userDetails._id === userId;
  };

  $scope.getBubbleClass = function(userId){
    var classname = 'from-them';
    if($scope.messageIsMine(userId)){
      classname = 'from-me';
    }
    return classname;
  };
  $scope.goToUserProfile = function () {
    UserService.SetUserProfile($scope.chatDetails);
    $state.go('app.userProfile',{userId:createrId })

  }

  $scope.sendMessage = function (msg) {
    date = new Date();
    $scope.dateString = date.toLocaleDateString();

    ChatService.sendMessage(msg, $scope.chatDetails);

    $scope.data.message = "";
    focus('email');
  }
    $ionicPopover.fromTemplateUrl('templates/shared/drop-down-menu.html', {
      scope: $scope,
    }).then(function(popover) {
      $scope.popover = popover;
    });


})
appControllers.controller('OnlineUserCtrl', function ($scope,$firebaseObject, ConfigurationService, EntityService) {
  var userDetails = ConfigurationService.UserDetails();
  var chatDetails = EntityService.getMessageDetails();
  var conversationId = chatDetails.conversationId;
  var createrId = conversationId.split("-")[0];
  var isUserOnlineRef = new Firebase('https://chatoi.firebaseio.com/presence/' + createrId);
  var blockedUrl = "https://chatoi.firebaseio.com/chats/" + createrId + "/blocked/" + userDetails._id;
  var blockedRef = new Firebase(blockedUrl);
  var blockUser = $firebaseObject(blockedRef);
  blockUser.$loaded(function(value){
    if(value.userId){
      $scope.isUserOnline = false;
    }
    else{
      isUserOnlineRef.on("value", function (userSnapshot) {
        if (userSnapshot.val() && userSnapshot.val() == 'online') {
          $scope.isUserOnline = true;
        }
        else{
          $scope.isUserOnline = false;
        }
      });
    }
  })

})
})();

(function () {
  appControllers.controller('loginCtrl', function ($scope, $state,UserService, $timeout) {
    $scope.fbLogin = function () {
      console.log("fblogin")
      if (window.cordova) {
        UserService.FBlogin().then(function success(s) {
          window.localStorage['fbData'] = angular.toJson(s.authResponse);
          var fbData = s.authResponse;

          var user = {
            fbToken: fbData['accessToken']
          }
          console.log(fbData['accessToken']);
          UserService.CreateUser(user)
            .then(function (user) {
              console.log("create")
              window.localStorage['user'] = angular.toJson(user);
              var ref = new Firebase("https://chatoi.firebaseio.com");

              ref.authWithCustomToken(user.fireToken, function (error, authData) {

                if (error) {
                  console.log("Login Failed!", error);
                } else {
                  console.log("subjects")

                  $state.go("tab.subjects");
                }
              });
              $state.go("tab.subjects");
            }, function (err) {
              console.log("Error ", err);
              alert("error")
            });
          //alert($scope.FbName)


        }, function error(msg) {
          console.log("Error while performing Facebook login", msg);
        })
      } else {
        var user = {
          fbToken: 'EAAZAMbMtmoBIBAHHzKvk8AewEB55ZAVYLLIr0ofhi6Eyhrnd6aHdOB1gQO3Im86QmqooFAZAHyj0uXAtwWOTXCnFRU6IvvhS4z7JZCZB12h8fTMsxr9JAZAHH40f2aqIodDXlbdIEMHHd6ZA3YHzrLm97jQh6VTha199Qst6u4ukO2mYvO4II5X8ZBTrVmT1yeIZD',
          notification_token: 'b95a00b4-96e0-41c6-9331-fa787a54291b'

        }

        UserService.CreateUser(user)
          .then(function (user) {
            window.localStorage['user'] = angular.toJson(user);
            var ref = new Firebase("https://chatoi.firebaseio.com");

            ref.authWithCustomToken(user.fireToken, function (error, authData) {

              if (error) {
                console.log("Login Failed!", error);
              } else {
                $state.go("tab.subjects");
              }
            });
            $state.go("tab.subjects");
          }, function (err) {
          });
      }

    };

  });
})();
// End of facebook login controller.

(function () {
appControllers.controller('messagesCtrl', function ($scope, $rootScope, $state, $stateParams, $timeout, $firebaseArray, ConfigurationService, MessagesService, UserService, EntityService) {

  $rootScope.isHeaderExpanded = true;
  $scope.$on('sendMessagesEvent', function(event, mass) {
    $scope.messages = MessagesService.getMessages();
    if(!$scope.$$phase) {
      $scope.$apply();
    }
  });
  MessagesService.setMessages();
  $scope.goToChat = function (message) {
    var messageDetails = {
      conversationId: message.conversationId,
      fbPhotoUrl: message.fbPhotoUrl,
      userName: message.userName,
      subjectName: message.subjectName
    }
    EntityService.setMessageDetails(messageDetails);
    $state.go('chat', {conversationId: message.conversationId})
  }

  $scope.goToUserProfile = function (message) {
    UserService.SetUserProfile(message);
    $state.go('userProfile')

  }
});
})();



(function () {
// Controller of expense dashboard page.
appControllers.controller('myProfileCtrl', function ($rootScope, $ionicPopup, $firebaseArray, $ionicLoading, $scope,$state,$stateParams,EntityService,SubjectService,ConfigurationService, UserService) {

  $scope.userProfile = ConfigurationService.UserDetails();// angular.fromJson(window.localStorage['user']);
  $scope.categoriesUrl = ConfigurationService.CategoriesUrl();
  $scope.subjects = [];
  $scope.deleteSubject = function (index, subject) {
    $scope.subjects.splice(index, 1);
    SubjectService.DeleteSubjects(subject)
      .then(function () {

      }, function (err) {
      });
  }

  $scope.logOut = function(){
    UserService.LogOut()
      .then(function () {
        window.localStorage.clear();
        ConfigurationService.LogOut();
        $state.go('login');
      }, function (err) {
        $state.go('login');
      });
  }

  $scope.tab = 'open';
  $scope.getSubjects = function(title){
    $scope.tab = title;
    $scope.subjects = [];
    $ionicLoading.show();

    if(title == 'open'){
      SubjectService.GetMySubjects($scope.userProfile._id, true)
        .then(function (subjects) {
          $scope.subjects = subjects.subjects;
          $ionicLoading.hide();
        }, function (err) {
          $ionicLoading.hide();
        });
    }else if(title == 'closed'){
      SubjectService.GetMySubjects($scope.userProfile._id, false)
        .then(function (subjects) {
          $scope.subjects = subjects.subjects;
          $ionicLoading.hide();
        }, function (err) {
          $ionicLoading.hide();
        });
    }else if(title == 'blocked'){
      var blockedUsersRef = new Firebase("https://chatoi.firebaseio.com/chats/" + $scope.userDetails._id+"/blocked/");
      $scope.blockedUsers = $firebaseArray(blockedUsersRef);
      $ionicLoading.hide();
    }
  }
  $scope.changeStatus = function(subject, index, status){
    $scope.subjects.splice(index,1);
    SubjectService.ChangeStatus(subject,status)
      .then(function (subjects) {

      }, function (err) {
      });
  }
  $scope.getSubjects('open');

  $scope.showConfirm = function(blockedUser) {
    var confirmPopup = $ionicPopup.confirm({
      title: 'Unblock User',
      template: 'Are you sure you want to remove'+ blockedUser.userName+' from your blocked users?'
    });
    confirmPopup.then(function(res) {
      if(res) {
        var blockedUserRef=new Firebase("https://chatoi.firebaseio.com/chats/" + $scope.userDetails._id+"/blocked/"+blockedUser.userId);
        blockedUserRef.remove();
        console.log('You are sure');
      } else {
        console.log('You are not sure');
      }
    });
  };
  $scope.userDetails = ConfigurationService.UserDetails();

});

appControllers.controller('userProfileCtrl', function ($rootScope, $scope,$state,$stateParams,EntityService,SubjectService,UserService) {
  $scope.isExpanded = true;
  $rootScope.isHeaderExpanded = false;
  $scope.userProfile = UserService.GetUserProfile();
  $scope.first_name = $scope.userProfile.first_name;

  $scope.a=function(){
    $state.go('app.subjects');
  }
  $scope.isAnimated =  $stateParams.isAnimated;
  //$scope.userProfile = angular.fromJson(window.localStorage['user']);
  $scope.subjects = [];
  SubjectService.GetMySubjects($scope.userProfile.userId)
    .then(function (subjects) {
      $scope.subjects = subjects;
    }, function (err) {
    });


  $scope.goToSetting = function () {
    $state.go("app.expenseSetting");
  };

});


appControllers.controller('profileSettingCtrl', function ($scope, $state,$ionicHistory,$ionicViewSwitcher) {

  $scope.navigateTo = function (stateName,objectData) {
    if ($ionicHistory.currentStateName() != stateName) {
      $ionicHistory.nextViewOptions({
        disableAnimate: false,
        disableBack: true
      });

      //Next view animate will display in back direction
      $ionicViewSwitcher.nextDirection('back');

      $state.go(stateName, {
        isAnimated: objectData,
      });
    }
  }; // End of navigateTo.
}); // End of controller expense dashboard setting.
})();

(function () {
  appControllers.controller('subjectsCtrl', function ($scope,$ionicScrollDelegate, $ionicModal, $ionicPlatform, $rootScope, $state, $interval, $stateParams, $timeout, SubjectService, EntityService, UserService, MessagesService, ConfigurationService, backcallFactory) {
    $scope.show = function(){
      var a = document.getElementById('dropdown-content');
      a.style.display = 'block';

    }
    $scope.scrollOptions = {
      skip: 0,
      limit: 20
    }
    function loadSubjects(callback){
      SubjectService.GetSubjects(false, $scope.scrollOptions)
        .then(function (subjects) {
          var s = [];
          angular.forEach(subjects.subjects, function(subject){
           s.push(subject);
          })
          $scope.subjectsCount = subjects.count;
          $scope.subjectsCount = subjects.count;
          callback(s);


        }, function (err) {
        });
    }

    $scope.loadOlderSubjects = function(){
      if($scope.subjects.length>0 ){
        $scope.scrollOptions.skip = $scope.subjects.length;
        $scope.scrollOptions.limit = 20;
      }

      loadSubjects(function(subjects){
        $scope.subjects = $scope.subjects.concat(subjects);
        $scope.$broadcast('scroll.infiniteScrollComplete');
        $ionicScrollDelegate.scrollBottom();
      })


    }
    $scope.loadNewrSubjects = function(){
      $scope.scrollOptions = {
        skip: 0,
        limit: 20
      }
      loadSubjects(function(subjects){
        $scope.subjects = [];
        $scope.subjects = $scope.subjects.concat(subjects);
        $scope.$broadcast('scroll.refreshComplete');
      })
    }
    $scope.subjects = [];
    SubjectService.GetCategories()
      .then(function (categories) {
      }, function (err) {
      });
    $ionicPlatform.ready(function () {
      doRefresh();
      backcallFactory.backCall();
      if (window.cordova && typeof window.plugins.OneSignal != 'undefined' && !ConfigurationService.Notification_token()) {
        $timeout(function () {
          window.plugins.OneSignal.getIds(function (ids) {

            UserService.RegisterNotification(ids.userId)
              .then(function (userToken) {
                ConfigurationService.SetNotification_token(userToken);
              }, function (err) {
              });
          });
        }, 5000)
      }
      $scope.userDetails = ConfigurationService.UserDetails();
      if($scope.userDetails){
        var amOnline = new Firebase('https://chatoi.firebaseio.com/.info/connected');
        var userRef = new Firebase('https://chatoi.firebaseio.com/presence/' + $scope.userDetails._id);
        var conversationUserRef = new Firebase('https://chatoi.firebaseio.com/conversationOnline/' + $scope.userDetails._id);
        amOnline.on('value', function(snapshot) {
          if (snapshot.val()) {
            userRef.onDisconnect().set('offline');
            conversationUserRef.onDisconnect().remove();
            userRef.set('online');
          }
        });
      }
    });

    $scope.checkUndreadMessage = function () {
      return MessagesService.checkUndreadMessage();
    }
    function doRefresh() {
      SubjectService.GetSubjects(false, $scope.scrollOptions)
        .then(function (subjects) {
          $scope.subjects = [];
          angular.forEach(subjects.subjects, function(subject){
            $scope.subjects.push(subject);
          })
          $scope.subjectsCount = subjects.count;
        }, function (err) {
        });
    }



    $scope.goToChat = function (subject) {

      var userName = subject.user.first_name + " " + subject.user.last_name;
      var messageDetails = {
        conversationId: subject.user._id + "-" + subject._id,
        userName: userName,
        subjectName: subject.title,
        fbPhotoUrl: subject.user.fbPhotoUrl
      }
      EntityService.setMessageDetails(messageDetails);
      $state.go('chat')
    }
    $scope.goToUserProfile = function (subject) {
      //
      //var userName = subject.user.first_name + " " + subject.user.last_name;
      //var messageDetails = {
      //  conversationId: subject.user._id + "-" + subject._id,
      //  userName: userName,
      //  subjectName: subject.title,
      //  fbPhotoUrl: subject.user.fbPhotoUrl
      //}
      //EntityService.setMessageDetails(messageDetails);
      $state.go('userProfile', {userId: subject.user._id, first_name: subject.user.first_name})
    }
    $scope.goToFilter = function () {
      $scope.modal.show();
    }
    $scope.goToMessages = function () {
      $state.go('tab.messages');
    }
    $scope.goToAddSubject = function () {
      $state.go('addSubject');
    }

    $ionicModal.fromTemplateUrl('templates/subjects/html/filter.html', {
      scope: $scope,
      animation: 'slide-in-up'
    }).then(function(modal) {
      $scope.modal = modal;
    });

    $scope.$on('$destroy', function() {
      $scope.modal.remove();
      console.log("$destroy")
    });
    // Execute action on hide modal
    $scope.$on('modal.hidden', function() {
      console.log("modal hiden");
      $rootScope.myFilter.categories = [];
      $scope.scrollOptions = {
        skip: 0,
        limit: 20
      }
      SubjectService.GetCategories()
        .then(function (categories) {
          $scope.categories = categories;
          angular.forEach($scope.categories, function (value, key) {
            if (value.is_selected) {
              $rootScope.myFilter.categories.push(value._id)
            }
          });
          ConfigurationService.SetMyFilter($rootScope.myFilter);
          doRefresh();
        }, function (err) {
        });

    });
    // Execute action on remove modal
    $scope.$on('modal.removed', function() {
      console.log("removed");
    });
  })
  appControllers.controller('addSubjectCtrl', function ($scope, $ionicLoading, $state, SubjectService, $stateParams, $filter, $ionicHistory, ConfigurationService, $ionicHistory) {
    $scope.isExpanded = true;
    $scope.failed = false;

    $scope.subject = {};
    $scope.categories = [];
    $scope.categoriesUrl = ConfigurationService.CategoriesUrl();
    $scope.initialForm = function () {

      $scope.subject = {
        title: '',
        user: ConfigurationService.UserDetails()._id,
        description: ''
      }
      SubjectService.GetCategories()
        .then(function (categories) {
          $scope.categories = categories;
        }, function (err) {
        });

    };
    $scope.createSubjectSetp = function (category) {
      $state.go('tab.addSubject-s2', {categoryId: category._id})
    }
    $scope.createSubject = function () {
      if ($scope.subject.title.length <= 0 || $scope.subject.description.length <= 0) {
        $scope.failed = true;
        return;
      }
      $scope.subject.category = $state.params.categoryId;
      $ionicLoading.show();
      SubjectService.CreateSubject($scope.subject)
        .then(function () {
          $ionicLoading.hide();
          $ionicHistory.clearHistory();
          $state.go("tab.subjects");

        }, function (err) {
          $ionicLoading.hide();
        });
    }


    $scope.initialForm();
  });
  appControllers.controller('filterCtrl', function ($scope, $rootScope, $state, $stateParams, $ionicHistory, SubjectService, ConfigurationService) {
    $scope.categoriesUrl = ConfigurationService.CategoriesUrl();

    $scope.setGender =function(gender){
      $rootScope.myFilter.gender = gender;
    }

    $scope.selectCategory = function (categoryIndex) {
      if($scope.categories[categoryIndex].is_selected)
        $scope.categories[categoryIndex].is_selected = false;
      else
        $scope.categories[categoryIndex].is_selected = true;
    }
    $scope.initialForm = function () {
      SubjectService.GetCategories()
        .then(function (categories) {
          $scope.categories = categories;
          for (var i = 0; i < $scope.categories.length; i++) {
            if ($rootScope.myFilter.categories.indexOf($scope.categories[i]._id) !== -1) {
              $scope.categories[i].is_selected = true;
            }
          }
        }, function (err) {
        });

      $rootScope.myFilter = ConfigurationService.MyFilter();
      if (!$rootScope.myFilter.gender) {
        $rootScope.myFilter = {
          nearMe: false,
          gender: 'both',
          categories: []
        }
        ConfigurationService.SetMyFilter($rootScope.myFilter);
      }

    };// End initialForm.
    $scope.initialForm();
  });// End of Notes Detail Page  Controller.

})();
